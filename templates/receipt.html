<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>Receipt {{ receipt["merchant_name"] }}</title>
	<meta name="google-site-verification" content="gEiw9Swqs11DLP3QTgR8Y6hHGjQnhSWWud7LivLEmHs" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,700,0,200" />
	<link rel="stylesheet" href="https://www.gruettecloud.com/static/stylesheet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="icon" href="https://www.gruettecloud.com/static/gruettecloud_logo.png">
    <style>
        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 10svh;
            padding-bottom: 40px;
        }

        .application-form {
            display: flex;
            flex-direction: column;
        }
        
    </style>
</head>
<body>
	<div class="header">
        <a href="/spending" style="position: absolute; left: 20px; top: 20px;">
            <span  class="material-symbols-outlined white-button-blue-on-hover" title="Back To Overview">arrow_back_ios_new</span>
        </a>
		<div class="centered-content">
            <a href="/" class="logo" title="Home">
                <img src="https://www.gruettecloud.com/static/gruettecloud_logo.png" style="width: 40px; height: 40px;" title="GrütteCloud">
            </a>
        </div>
        {% include "components/nav-element.html" %}
	</div>

    <div class="content">
        <div style="display: flex; flex-direction: column; align-items: center; background-color: #FFFFFF; color: #000000; border-radius: 20px; padding: 20px; max-width: 90vw; width: 400px; overflow: hidden;">
            {% if receipt["merchant_name"].lower() in ["lidl", "edeka", "kauland", "aldi", "amazon", "apple", "netflix", "spotify", "nike", "ikea", "mediamarkt", "saturn", "zalando"] %}
                <img src="https://cdn.simpleicons.org/{{ receipt["merchant_name"] }}/black" style="height: 100px; margin-top: 20px;">
            {% elif "google" in receipt["merchant_name"].lower() %}
                <img src="https://cdn.simpleicons.org/google/black" style="height: 100px; margin-top: 20px;">
            {% elif "telekom" in receipt["merchant_name"].lower() %}
                <img src="https://cdn.simpleicons.org/tmobile/black" style="height: 100px; margin-top: 20px;">
            {% else %}
                <span class="material-symbols-outlined" style="font-size: 100px; margin-top: 20px;">shopping_cart</span>
            {% endif %}
                
            <div style="display: flex; justify-content: flex-end; width: 100%; cursor: pointer;" onclick="editReceipt()">
                <span class="material-symbols-outlined">edit</span>
            </div>
            
            <h1 class="item_original" style="margin-bottom: 10px; display: flex;">{{ receipt["merchant_name"] }}</h1>
            <p class="item_id" style="display: none;">merchant_name</p>
            <input type="text" class="item_edit" style="margin: 0; display: none;" value="{{ receipt["merchant_name"] }}">

            <p style="margin-bottom: 30px;">{{ receipt["date"] }}</p>
            {% for item in items %}
                <div style="display: flex; justify-content: space-between; width: 100%; gap: 10px; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                    <p class="item_original" style="flex: 1; margin: 0; text-align: left; display: flex;">{{ item["item"] }}</p>
                    <p class="item_original" style="margin: 0; display: flex;">{{ item["price"] }} €</p>
                    <p class="item_id" style="display: none;">{{ item["id"] }}</p>
                    <p class="item_id" style="display: none;">{{ item["id"] }}</p>


                    <input type="text" class="item_edit" style="width: 90%; margin: 0; text-align: left; display: flex; display: none;" value="{{ item["item"] }}">
                    <input type="text" class="item_edit" style="width: 20%; margin: 0; display: flex; display: none;" value="{{ item["price"] }}">
                    <button class="button-blue edit-only" style="margin: 0; display: none; background-color: var(--red);" onclick="deleteItem({{ item["id"] }})">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            {% endfor %}
            {% if items|length == 0 %}
                <b style="margin: 15px;">Manual Receipt</b>
                <p style="margin-bottom: 30px; text-align: center;">Adding items to this type of receipt is not supported yet.</p>
            {% endif %}
            <div style="display: flex; justify-content: space-between; width: 100%; gap: 20px; margin-bottom: 10px; padding: 10px;">
                <b style="flex: 1; margin: 0; text-align: left;">Total</b>
                <b class="item_original" style="margin: 0; display: flex;">{{ receipt["total"] }} €</b>
                <p class="item_id" style="display: none;">total</p>
                <input type="text" class="item_edit" style="width: 20%; margin: 0; text-align: left; display: none;" value="{{ receipt["total"] }}">
            </div>
                
            <p style="margin-bottom: 20px; margin-top: 20px; text-align: center; display: flex; align-items: center; justify-content: center;">
                Paid with:
                <img src="https://www.gruettecloud.com/static/icons/applePayLogo.svg" class="align-icons-center" style="height: 30px; margin-left: 10px;">
            </p>

            <button class="button-blue edit-only" style="margin-top: 20px; width: 100%; display: none;" onclick="saveReceipt()">Save</button>
            <button class="button-blue edit-only" style="margin-top: 20px; width: 100%; background-color: var(--red); display: none;" onclick="deleteReceipt()">Delete</button>
        </div>
    </div>
	<div id="cookie-banner"></div>
    {% include "components/error.html" %}

</body>
</html>

<script>
    function editReceipt() {
        let items = document.getElementsByClassName("item_original");
        let items_edit = document.getElementsByClassName("item_edit");

        if (items[0].style.display == "none") {
            for (let i = 0; i < items.length; i++) {
                items[i].style.display = "flex";
                items_edit[i].style.display = "none";
            }
            for (let i = 0; i < document.getElementsByClassName("edit-only").length; i++) {
                document.getElementsByClassName("edit-only")[i].style.display = "none";
            }
            return;
        } else {
            for (let i = 0; i < items.length; i++) {
                items[i].style.display = "none";
                items_edit[i].style.display = "flex";
            }
            for (let i = 0; i < document.getElementsByClassName("edit-only").length; i++) {
                document.getElementsByClassName("edit-only")[i].style.display = "block";
            }
        }
    }
</script>

<script>
    function saveReceipt() {
        var items = document.getElementsByClassName("item_original");
        var item_edit = document.getElementsByClassName("item_edit");
        var item_ids = document.getElementsByClassName("item_id");
        
        var items_changed = [];

        for (let i = 0; i < items.length; i++) {
            copy = items[i].innerHTML;
            copy = copy.replace(" €", "");
            if (copy != item_edit[i].value) {
                items_changed.push({
                    "new": item_edit[i].value,
                    "old": copy,
                    "id": item_ids[i].innerHTML,
                });
            }
        }

        console.log(items_changed);

        if (items_changed.length == 0) {
            return;
        }

        // make request to save changes
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/receipt/edit/{{ receipt_id }}", true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    window.location.href = "/receipt/{{ receipt_id }}";
                } else {
                    console.error("Request failed with status: " + xhr.status);
                }
            }
        };

        xhr.send(JSON.stringify(items_changed));

    }

    function deleteReceipt() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/receipt/delete/{{ receipt_id }}", true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send();
        window.location.href = "/spending";
    }
</script>

<script src="https://www.gruettecloud.com/static/cookies.js"></script>
<script src="https://www.gruettecloud.com/static/darkmode.js"></script>
