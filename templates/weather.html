<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wetter</title>
    <link rel="icon" href="{{ url_prefix }}/static/favicon.ico" type="image/x-icon">
    <meta name="description" content="Willkommen auf Jamaillia.net">
    <link rel="stylesheet" href="{{ url_prefix }}/static/styles.css">
    {% if not public_version %}
        <script src="{{ url_prefix }}/static/darkMap.js"></script>
    {% else %}
        <script src="{{ url_prefix }}/static/darkPublicMap.js"></script>
    {% endif %}
    <link rel="stylesheet" href="{{ url_prefix }}/static/animate.css" />
    <link href="{{ url_prefix }}/static/fonts.css" rel="stylesheet">
    <script src="{{ url_prefix }}/static/plotly-3.0.0.min.js"></script>
    <link href="{{ url_prefix }}/static/mapbox-gl.css" rel="stylesheet">
    <script src="{{ url_prefix }}/static/mapbox-gl.js"></script>
    <link rel="stylesheet" href="{{ url_prefix }}/static/leaflet.css" />
    <script src="{{ url_prefix }}/static/leaflet.js"></script>
</head>
<body style="min-height: 100vh; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: 'Nunito', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: end;">
    {% if not public_version %}
        <div id="map" style="position: absolute; z-index: 0; top: 0; height: 40svh; width: 100%; margin: 0; padding: 0; -webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, 1) 100%);"></div>
    {% else %}
        <img id="map" src="{{ url_prefix }}/static/locationImages/{{ locations[0]['location'] if locations[0]['location'] != "Stammheimer Straße" else "StammheimerStrasse" }}_dark.png" style="position: absolute; object-fit: cover; z-index: 0; top: 0; height: 40vh; width: 100%; margin: 0; padding: 0; -webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, 1) 100%);">
    {% endif %}


    {% include "sidebar_component.html" %}
    <select id="location-selector" style="text-align: left; position: absolute; top: 20px; left: 60px; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; font-size: 1.4em; color: var(--text); background-color: transparent; border: none;">
        {% for location in locations %}
            <option value="{{ location['location'] }}" data-lon="{{ location['lon'] }}" data-lat="{{ location['lat'] }}">
                {{ location['location'] }}
            </option>
        {% endfor %}
    </select>
    
    <script>
        var weather_data = {{ weather_data|tojson }};


        document.getElementById("location-selector").addEventListener("change", function() {
            var selectedOption = this.options[this.selectedIndex];
            var lon = selectedOption.getAttribute("data-lon");
            var lat = selectedOption.getAttribute("data-lat");
    
            if (lon && lat) {
                selectLocation(parseFloat(lon), parseFloat(lat), selectedOption);

                for (var i = 0; i < weather_data.length; i++) {
                    var location = weather_data[i];
                    if (location["location"]["location"] == selectedOption.value) {

                        updateWeatherAPI(lat, lon);


                        document.getElementById("weather-val").innerHTML = location["weather_code"];
                        if (location["weather_code"] == 0) {
                            document.getElementById("weather-val").innerHTML = "Klarer Himmel";
                        } else if (location["weather_code"] == 1) {
                            document.getElementById("weather-val").innerHTML = "Überwiegend klar";
                        } else if (location["weather_code"] == 2) {
                            document.getElementById("weather-val").innerHTML = "Teils bewölkt";
                        } else if (location["weather_code"] == 3) {
                            document.getElementById("weather-val").innerHTML = "Bedeckt";
                        } else if (location["weather_code"] == 45) {
                            document.getElementById("weather-val").innerHTML = "Nebel";
                        } else if (location["weather_code"] == 48) {
                            document.getElementById("weather-val").innerHTML = "Ablagernder Reifnebel";
                        } else if (location["weather_code"] == 51) {
                            document.getElementById("weather-val").innerHTML = "Sprühregen (leicht)";
                        } else if (location["weather_code"] == 53) {
                            document.getElementById("weather-val").innerHTML = "Sprühregen (mäßig)";
                        } else if (location["weather_code"] == 55) {
                            document.getElementById("weather-val").innerHTML = "Sprühregen (stark)";
                        } else if (location["weather_code"] == 56) {
                            document.getElementById("weather-val").innerHTML = "Gefrierender Sprühregen (leicht)";
                        } else if (location["weather_code"] == 57) {
                            document.getElementById("weather-val").innerHTML = "Gefrierender Sprühregen (stark)";
                        } else if (location["weather_code"] == 61) {
                            document.getElementById("weather-val").innerHTML = "Regen (leicht)";
                        } else if (location["weather_code"] == 63) {
                            document.getElementById("weather-val").innerHTML = "Regen (mäßig)";
                        } else if (location["weather_code"] == 65) {
                            document.getElementById("weather-val").innerHTML = "Regen (stark)";
                        } else if (location["weather_code"] == 66) {
                            document.getElementById("weather-val").innerHTML = "Gefrierender Regen (leicht)";
                        } else if (location["weather_code"] == 67) {
                            document.getElementById("weather-val").innerHTML = "Gefrierender Regen (stark)";
                        } else if (location["weather_code"] == 71) {
                            document.getElementById("weather-val").innerHTML = "Schneefall (leicht)";
                        } else if (location["weather_code"] == 73) {
                            document.getElementById("weather-val").innerHTML = "Schneefall (mäßig)";
                        } else if (location["weather_code"] == 75) {
                            document.getElementById("weather-val").innerHTML = "Schneefall (stark)";
                        } else if (location["weather_code"] == 77) {
                            document.getElementById("weather-val").innerHTML = "Schneekörner";
                        } else if (location["weather_code"] == 80) {
                            document.getElementById("weather-val").innerHTML = "Regenschauer (leicht)";
                        } else if (location["weather_code"] == 81) {
                            document.getElementById("weather-val").innerHTML = "Regenschauer (mäßig)";
                        } else if (location["weather_code"] == 82) {
                            document.getElementById("weather-val").innerHTML = "Regenschauer (stark)";
                        } else if (location["weather_code"] == 85) {
                            document.getElementById("weather-val").innerHTML = "Schneeschauer (leicht)";
                        } else if (location["weather_code"] == 86) {
                            document.getElementById("weather-val").innerHTML = "Schneeschauer (stark)";
                        } else if (location["weather_code"] == 95) {
                            document.getElementById("weather-val").innerHTML = "Gewitter (leicht oder mäßig)";
                        } else if (location["weather_code"] == 96) {
                            document.getElementById("weather-val").innerHTML = "Gewitter mit leichtem Hagel";
                        } else if (location["weather_code"] == 99) {
                            document.getElementById("weather-val").innerHTML = "Gewitter mit starkem Hagel";
                        } else {
                            document.getElementById("weather-val").innerHTML = "Unbekanntes Wetter";
                        }

                        document.getElementById("temperature-val").innerHTML = location["last_temperature"]["value"];
                        document.getElementById("temperature-timestamp").innerHTML = "Aktualisiert: " + location["last_temperature"]["timestamp"];
                        if (location["last_temperature"]["value"]) {
                            document.getElementById("temperature-tile").style.display = "flex";
                        } else {
                            document.getElementById("temperature-tile").style.display = "none";
                        }

                        document.getElementById("humidity-val").innerHTML = location["last_humidity"]["value"];
                        document.getElementById("humidity-timestamp").innerHTML = "Aktualisiert: " + location["last_humidity"]["timestamp"];
                        if (location["last_humidity"]["value"]) {
                            document.getElementById("humidity-tile").style.display = "flex";
                        } else {
                            document.getElementById("humidity-tile").style.display = "none";
                        }

                        document.getElementById("air-pressure-val").innerHTML = location["last_pressure"]["value"];
                        document.getElementById("air-pressure-timestamp").innerHTML = "Aktualisiert: " + location["last_pressure"]["timestamp"];
                        if (location["last_pressure"]["value"]) {
                            document.getElementById("air-pressure-tile").style.display = "flex";
                        } else {
                            document.getElementById("air-pressure-tile").style.display = "none";
                        }

                        document.getElementById("pm-2-5-val").innerHTML = location["last_pm_2_5"]["value"];
                        document.getElementById("pm-timestamp").innerHTML = "Aktualisiert: " + location["last_pm_2_5"]["timestamp"];
                        if (location["last_pm_2_5"]["value"]) {
                            document.getElementById("pm-2-5-tile").style.display = "flex";
                        } else {
                            document.getElementById("pm-2-5-tile").style.display = "none";
                        }

                        document.getElementById("aqi-val").innerHTML = location["aqi"];
                        document.getElementById("aqi-timestamp").innerHTML = "Aktualisiert: " + location["last_pm_2_5"]["timestamp"];
                        if (location["aqi"]) {
                            document.getElementById("aqi-tile").style.display = "flex";
                        } else {
                            document.getElementById("aqi-tile").style.display = "none";
                        }

                        var hoursTemp = [];
                        var temperatures = [];
                        var hoursHumidity = [];
                        var humidities = [];
                        var hoursPM = [];
                        var pm_2_5 = [];
                        var hoursPressure = [];
                        var pressures = [];

                        for (var i = 0; i < location["all_temp_last_24h"].length; i++) {
                            hoursTemp.push(location["all_temp_last_24h"][i]["two_hour_block"]);
                            temperatures.push(location["all_temp_last_24h"][i]["avg_temperature"]);
                        }

                        for (var i = 0; i < location["all_humidity_last_24h"].length; i++) {
                            hoursHumidity.push(location["all_humidity_last_24h"][i]["two_hour_block"]);
                            humidities.push(location["all_humidity_last_24h"][i]["avg_humidity"]);
                        }

                        for (var i = 0; i < location["all_pm_2_5_last_24h"].length; i++) {
                            hoursPM.push(location["all_pm_2_5_last_24h"][i]["two_hour_block"]);
                            pm_2_5.push(location["all_pm_2_5_last_24h"][i]["avg_pm_2_5"]);
                        }

                        for (var i = 0; i < location["all_pressure_last_24h"].length; i++) {
                            hoursPressure.push(location["all_pressure_last_24h"][i]["two_hour_block"]);
                            pressures.push(location["all_pressure_last_24h"][i]["avg_pressure"]);
                        }

                        // delay to make sure the graph is rendered after the tile is displayed
                        setTimeout(() => {
                            createPlotlyGraph(temperatures, hoursTemp, "temperaturePlot");
                            createPlotlyGraph(humidities, hoursHumidity, "humidityPlot");
                            createPlotlyGraph(pm_2_5, hoursPM, "pm-2-5-Plot");
                            createPlotlyGraph(pressures, hoursPressure, "pressurePlot");
                        }, 10);
                        /*createPlotlyGraph(temperatures, hoursTemp, "temperaturePlot");
                        createPlotlyGraph(humidities, hoursHumidity, "humidityPlot");
                        createPlotlyGraph(pm_2_5, hoursPM, "pm-2-5-Plot");*/
                        
                        
                        if (location["last_temperature"]["value"]) {
                            document.getElementById("temperature-graph-tile").style.display = "flex";
                        } else {
                            document.getElementById("temperature-graph-tile").style.display = "none";
                        }

                        if (location["last_humidity"]["value"]) {
                            document.getElementById("humidity-graph-tile").style.display = "flex";
                        } else {
                            document.getElementById("humidity-graph-tile").style.display = "none";
                        }

                        if (location["last_pm_2_5"]["value"]) {
                            document.getElementById("pm-2-5-graph-tile").style.display = "flex";
                        } else {
                            document.getElementById("pm-2-5-graph-tile").style.display = "none";
                        }

                        if (location["last_pressure"]["value"]) {
                            document.getElementById("pressure-graph-tile").style.display = "flex";
                        } else {
                            document.getElementById("pressure-graph-tile").style.display = "none";
                        }
                    }
                }
            }
        });
    
        function selectLocation(lon, lat, location) {
            {% if not public_version %}
                map.flyTo({
                    center: [lon, lat],
                    zoom: 16,
                    speed: 1,
                    curve: 1,
                    easing: (t) => t,
                    pitch: 50,
                });
            {% else %}
                var map = document.getElementById("map");
                var current_src = map.src;
                var location = location.value;
                if (location == "Stammheimer Straße") {
                    location = "StammheimerStrasse";
                }
                if (current_src.includes("_dark.png")) {
                    map.src = "{{ url_prefix }}/static/locationImages/" + location + "_dark.png";
                } else {
                    map.src = "{{ url_prefix }}/static/locationImages/" + location + "_light.png";
                }
            {% endif %}
        }
    </script>
    

    <div id="weather-tiles" class="container animate__animated" style="margin-bottom: 20px; margin-top: 30vh;">
        <div id="weather-tile" class="card"  style="display: {% if weather_data[0]["weather_code"] != None %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">partly_cloudy_day</span>
                        Wetter
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 0px; flex-direction: column;">
                    <span id="weather-val" style="font-family: 'Montserrat', sans-serif; width: calc(100% - 30px);">
                        {% if weather_data[0]["weather_code"] == 0 %}
                            Klarer Himmel
                        {% elif weather_data[0]["weather_code"] == 1 %}
                            Überwiegend klar
                        {% elif weather_data[0]["weather_code"] == 2 %}
                            Teils bewölkt
                        {% elif weather_data[0]["weather_code"] == 3 %}
                            Bedeckt
                        {% elif weather_data[0]["weather_code"] == 45 %}
                            Nebel
                        {% elif weather_data[0]["weather_code"] == 48 %}
                            Ablagernder Reifnebel
                        {% elif weather_data[0]["weather_code"] == 51 %}
                            Sprühregen (leicht)
                        {% elif weather_data[0]["weather_code"] == 53 %}
                            Sprühregen (mäßig)
                        {% elif weather_data[0]["weather_code"] == 55 %}
                            Sprühregen (stark)
                        {% elif weather_data[0]["weather_code"] == 56 %}
                            Gefrierender Sprühregen (leicht)
                        {% elif weather_data[0]["weather_code"] == 57 %}
                            Gefrierender Sprühregen (stark)
                        {% elif weather_data[0]["weather_code"] == 61 %}
                            Regen (leicht)
                        {% elif weather_data[0]["weather_code"] == 63 %}
                            Regen (mäßig)
                        {% elif weather_data[0]["weather_code"] == 65 %}
                            Regen (stark)
                        {% elif weather_data[0]["weather_code"] == 66 %}
                            Gefrierender Regen (leicht)
                        {% elif weather_data[0]["weather_code"] == 67 %}
                            Gefrierender Regen (stark)
                        {% elif weather_data[0]["weather_code"] == 71 %}
                            Schneefall (leicht)
                        {% elif weather_data[0]["weather_code"] == 73 %}
                            Schneefall (mäßig)
                        {% elif weather_data[0]["weather_code"] == 75 %}
                            Schneefall (stark)
                        {% elif weather_data[0]["weather_code"] == 77 %}
                            Schneekörner
                        {% elif weather_data[0]["weather_code"] == 80 %}
                            Regenschauer (leicht)
                        {% elif weather_data[0]["weather_code"] == 81 %}
                            Regenschauer (mäßig)
                        {% elif weather_data[0]["weather_code"] == 82 %}
                            Regenschauer (stark)
                        {% elif weather_data[0]["weather_code"] == 85 %}
                            Schneeschauer (leicht)
                        {% elif weather_data[0]["weather_code"] == 86 %}
                            Schneeschauer (stark)
                        {% elif weather_data[0]["weather_code"] == 95 %}
                            Gewitter (leicht oder mäßig)
                        {% elif weather_data[0]["weather_code"] == 96 %}
                            Gewitter mit leichtem Hagel
                        {% elif weather_data[0]["weather_code"] == 99 %}
                            Gewitter mit starkem Hagel
                        {% else %}
                            Unbekanntes Wetter
                        {% endif %}
                    </span>
                </span>
            </div>
            <script>
                function getTime() {
                    let now = new Date();
                    let hours = now.getHours().toString().padStart(2, '0');
                    let minutes = now.getMinutes().toString().padStart(2, '0');
                    return hours + ":" + minutes;
                }
            </script>
            
            <span style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: <script>document.write(getTime());</script></span>
        </div>
        <div id="temperature-tile" class="card"  style="display: {% if weather_data[0]["last_temperature"]["value"] %}flex{% else %}flex{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded" style="font-size: 1.4em;">thermostat</span>
                        Temperatur
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 8px;">
                    <span id="temperature-val" style="font-family: 'Montserrat', sans-serif;">
                        {{ weather_data[0]["last_temperature"]["value"] }}
                    </span>
                    <span id="temperature-val-unit">°C</span>
                </span>
            </div>
            <span id="temperature-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: {{ weather_data[0]["last_temperature"]["timestamp"] }}</span>
        </div>
        <div id="temperature-graph-tile" class="card card-double-width"  style="display: {% if weather_data[0]["all_temp_last_24h"][0]["avg_temperature"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">thermostat</span>
                        Temperatur in °C
                    </span>
                    <select id="temperature-range-selector" style="width: auto; z-index: 5; text-align: right; font-family: 'Nunito', sans-serif; font-size: 1em; color: var(--text-light); background-color: var(--bg-tile); border: none; padding: 0; padding-right: 5px;">
                        <option value="24h" selected>24 Stunden</option>
                        <option value="7d">7 Tage</option>
                        <option value="30d">30 Tage</option>
                        <option value="90d">90 Tage</option>
                    </select>
                </span>
                <div id="temperaturePlot" class="tile-item-height"></div>
            </div>
        </div>


        <div id="humidity-graph-tile" class="card card-double-width"  style="display: {% if weather_data[0]["all_humidity_last_24h"][0]["avg_humidity"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">humidity_percentage</span>
                        Luftfeuchtigkeit in %
                    </span>
                    <select id="humidity-range-selector" style="z-index: 5; text-align: right; font-family: 'Nunito', sans-serif; font-size: 1em; color: var(--text-light); background-color: var(--bg-tile); border: none; padding: 0; padding-right: 5px;">
                        <option value="24h" selected>24 Stunden</option>
                        <option value="7d">7 Tage</option>
                        <option value="30d">30 Tage</option>
                        <option value="90d">90 Tage</option>
                    </select>
                </span>
                <div id="humidityPlot" class="tile-item-height"></div>
            </div>
        </div>
        <div id="humidity-tile" class="card"  style="display: {% if weather_data[0]["last_humidity"]["value"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded" style="font-size: 1.4em;">humidity_percentage</span>
                        Luftfeuchtigkeit
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 8px;">
                    <span id="humidity-val" style="font-family: 'Montserrat', sans-serif;">
                        {{ weather_data[0]["last_humidity"]["value"] }}
                    </span>
                    <span id="humidity-val-unit">%</span>
                </span>
            </div>
            <span id="humidity-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: {{ weather_data[0]["last_humidity"]["timestamp"] }}</span>
        </div>
        <div id="air-pressure-tile" class="card"  style="display: {% if weather_data[0]["last_pressure"]["value"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">speed</span>
                        Luftdruck
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 0px; flex-direction: column;">
                    <span id="air-pressure-val" style="font-family: 'Montserrat', sans-serif;">
                        {{ weather_data[0]["last_pressure"]["value"] }}
                    </span>
                    <span id="air-pressure-val-unit">hPa</span>
                </span>
            </div>
            <span id="air-pressure-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: {{ weather_data[0]["last_pressure"]["timestamp"] }}</span>
        </div>

        <div id="pm-2-5-graph-tile" class="card card-double-width" style="display: {% if weather_data[0]["all_pm_2_5_last_24h"][0]["avg_pm_2_5"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: end; gap: 10px;">
                        <span class="material-symbols-rounded">lens_blur</span>
                        <span class="desktop-only" style="align-items: end;">PM<sub style="margin-right: 5px;">2.5</sub> in µg/m³</span>
                        <span class="mobile-only" style="align-items: end;">PM<sub>2.5</sub></span>
                    </span>
                    <select id="pm-2-5-range-selector" style="z-index: 5; text-align: right; font-family: 'Nunito', sans-serif; font-size: 1em; color: var(--text-light); background-color: var(--bg-tile); border: none; padding: 0; padding-right: 5px;">
                        <option value="24h" selected>24 Stunden</option>
                        <option value="7d">7 Tage</option>
                        <option value="30d">30 Tage</option>
                        <option value="90d">90 Tage</option>
                    </select>
                </span>
                <div id="pm-2-5-Plot" class="tile-item-height"></div>
            </div>
        </div>
        <div id="pm-2-5-tile" class="card"  style="display: {% if weather_data[0]["last_pm_2_5"]["value"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: end; gap: 10px;">
                        <span class="material-symbols-rounded">lens_blur</span>
                        <span class="desktop-only" style="align-items: end;">Feinstaub PM<sub>2.5</sub></span>
                        <span class="mobile-only">Feinstaub</span>
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 0px; flex-direction: column;">
                    <span id="pm-2-5-val" style="font-family: 'Montserrat', sans-serif;">
                        {{ weather_data[0]["last_pm_2_5"]["value"] }}
                    </span>
                    <span id="pm-val-unit">µg/m³</span>
                </span>
            </div>
            <span id="pm-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: {{ weather_data[0]["last_pm_2_5"]["timestamp"] }}</span>
        </div>
        <div id="aqi-tile" class="card"  style="display: {% if weather_data[0]["aqi"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">lens_blur</span>
                        Luftqualität
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 0px; flex-direction: column;">
                    <span id="aqi-val" style="font-family: 'Montserrat', sans-serif;">
                        {{ weather_data[0]["aqi"] }}
                    </span>
                </span>
            </div>
            <span id="aqi-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: {{ weather_data[0]["last_pm_2_5"]["timestamp"] }}</span>
        </div>



        <div id="pressure-graph-tile" class="card card-double-width" style="display: {% if weather_data[0]["all_pressure_last_24h"][0]["avg_pressure"] %}flex{% else %}none{% endif%};">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: end; gap: 10px;">
                        <span class="material-symbols-rounded">speed</span>
                        Luftdruck in hPa
                    </span>
                    <select id="pressure-range-selector" style="z-index: 5; text-align: right; font-family: 'Nunito', sans-serif; font-size: 1em; color: var(--text-light); background-color: var(--bg-tile); border: none; padding: 0; padding-right: 5px;">
                        <option value="24h" selected>24 Stunden</option>
                        <option value="7d">7 Tage</option>
                        <option value="30d">30 Tage</option>
                        <option value="90d">90 Tage</option>
                    </select>
                </span>
                <div id="pressurePlot" class="tile-item-height" style="width: calc(100% - 30px);"></div>
            </div>
        </div>

        <div id="wind-speed-tile" class="card"  style="display: flex;">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">air</span>
                        <span class="desktop-only" style="align-items: end;">Windgeschwindigkeit</span>
                        <span class="mobile-only">Wind</span>
                    </span>
                </span>
                <span style="display: flex; justify-content: start; align-items: start; gap: 0px; flex-direction: column;">
                    <span id="wind-speed-val" style="font-family: 'Montserrat', sans-serif;">
                        Wird geladen...
                    </span>
                    <span id="wind-speed-val-unit">km/h</span>
                </span>
            </div>
            <span id="wind-speed-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: <script>document.write(getTime());</script></span>
        </div>
        <div id="wind-direction-tile" class="card"  style="display: flex;">
            <div class="card-body">
                <span class="card-title" style="display: flex; justify-content: space-between; width: calc(100% - 30px);">
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded">near_me</span>
                        Windrichtung
                    </span>
                </span>
                <span style="display: flex; justify-content: space-between; align-items: start; gap: 0px; flex-direction: row; width: calc(100% - 30px);">
                    <div class="compass-container">
                        <div class="compass-arrow material-symbols-rounded" id="wind-direction-arrow">south</div>
                        <div class="compass-label label-n">N</div>
                        <div class="compass-label label-e">E</div>
                        <div class="compass-label label-s">S</div>
                        <div class="compass-label label-w">W</div>
                    </div>
                <span id="wind-direction-val" style="font-family: 'Montserrat', sans-serif; font-size: 1.6em; padding: 0 15px 15px; height: 100%; display: flex; justify-content: start; align-items: center;"></span>
                <span></span>
            </div>
            <span id="wind-direction-timestamp" style="color: var(--text-light); font-family: 'Nunito', sans-serif; padding: 0 15px 15px; font-size: 0.8em; display: flex; justify-content: space-between; width: calc(100% - 30px);">Aktualisiert: <script>document.write(getTime());</script></span>
        </div>
        
        <!-- map and weathapi credits -->
        <div class="credits-footer" style="">
            <span>
                <a href="https://www.mapbox.com" target="_blank">© Mapbox</a> |
                <a href="http://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap</a> |
                <a href="https://www.mapbox.com/map-feedback/" target="_blank">Karte verbessern</a> |
                <a href="https://open-meteo.com" target="_blank">Open-Meteo.com</a>
            </span>
            <span>
                <a href="https://jan.gruettefien.com" target="_blank">© Jan Grüttefien</a>
            </span>
        </div>
    </div>
</body>
<script>

    const zoomBasedReveal = (value) => {
        return [
            'interpolate',
            ['linear'],
            ['zoom'],
            11,
            0.0,
            13,
            value
        ];
    };


    function updateWeatherAPI(lat, lon) {
        var url = "https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=weather_code,temperature_2m,wind_speed_10m,wind_direction_10m";
        fetch(url)
            .then(response => response.json())
            .then(data => {
                var weatherCode = data["current"]["weather_code"];
                document.getElementById("weather-val").innerHTML = weatherCode;
                if (weatherCode == 0) {
                    document.getElementById("weather-val").innerHTML = "Klarer Himmel";
                } else if (weatherCode == 1) {
                    document.getElementById("weather-val").innerHTML = "Überwiegend klar";
                } else if (weatherCode == 2) {
                    document.getElementById("weather-val").innerHTML = "Teils bewölkt";
                } else if (weatherCode == 3) {
                    document.getElementById("weather-val").innerHTML = "Bedeckt";
                } else if (weatherCode == 45) {
                    document.getElementById("weather-val").innerHTML = "Nebel";
                } else if (weatherCode == 48) {
                    document.getElementById("weather-val").innerHTML = "Ablagernder Reifnebel";
                } else if (weatherCode == 51) {
                    document.getElementById("weather-val").innerHTML = "Sprühregen (leicht)";
                } else if (weatherCode == 53) {
                    document.getElementById("weather-val").innerHTML = "Sprühregen (mäßig)";
                } else if (weatherCode == 55) {
                    document.getElementById("weather-val").innerHTML = "Sprühregen (stark)";
                } else if (weatherCode == 56) {
                    document.getElementById("weather-val").innerHTML = "Gefrierender Sprühregen (leicht)";
                } else if (weatherCode == 57) {
                    document.getElementById("weather-val").innerHTML = "Gefrierender Sprühregen (stark)";
                } else if (weatherCode == 61) {
                    document.getElementById("weather-val").innerHTML = "Regen (leicht)";
                } else if (weatherCode == 63) {
                    document.getElementById("weather-val").innerHTML = "Regen (mäßig)";
                } else if (weatherCode == 65) {
                    document.getElementById("weather-val").innerHTML = "Regen (stark)";
                } else if (weatherCode == 66) {
                    document.getElementById("weather-val").innerHTML = "Gefrierender Regen (leicht)";
                } else if (weatherCode == 67) {
                    document.getElementById("weather-val").innerHTML = "Gefrierender Regen (stark)";
                } else if (weatherCode == 71) {
                    document.getElementById("weather-val").innerHTML = "Schneefall (leicht)";
                } else if (weatherCode == 73) {
                    document.getElementById("weather-val").innerHTML = "Schneefall (mäßig)";
                } else if (weatherCode == 75) {
                    document.getElementById("weather-val").innerHTML = "Schneefall (stark)";
                } else if (weatherCode == 77) {
                    document.getElementById("weather-val").innerHTML = "Schneekörner";
                } else if (weatherCode == 80) {
                    document.getElementById("weather-val").innerHTML = "Regenschauer (leicht)";
                } else if (weatherCode == 81) {
                    document.getElementById("weather-val").innerHTML = "Regenschauer (mäßig)";
                } else if (weatherCode == 82) {
                    document.getElementById("weather-val").innerHTML = "Regenschauer (stark)";
                } else if (weatherCode == 85) {
                    document.getElementById("weather-val").innerHTML = "Schneeschauer (leicht)";
                } else if (weatherCode == 86) {
                    document.getElementById("weather-val").innerHTML = "Schneeschauer (stark)";
                } else if (weatherCode == 95) {
                    document.getElementById("weather-val").innerHTML = "Gewitter (leicht oder mäßig)";
                } else if (weatherCode == 96) {
                    document.getElementById("weather-val").innerHTML = "Gewitter mit leichtem Hagel";
                } else if (weatherCode == 99) {
                    document.getElementById("weather-val").innerHTML = "Gewitter mit starkem Hagel";
                } else {
                    document.getElementById("weather-val").innerHTML = "Unbekanntes Wetter";
                }

                if ([71, 73, 75, 77, 85, 86].includes(weatherCode)) {
                    map.setSnow({
                        density: zoomBasedReveal(0.85),
                        intensity: 1.0,
                        'center-thinning': 0.1,
                        direction: [0, 50],
                        opacity: 1.0,
                        color: `#ffffff`,
                        'flake-size': 0.71,
                        vignette: zoomBasedReveal(0.3),
                        'vignette-color': `#ffffff`
                    });
                } else if ([51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(weatherCode)) {
                    map.setRain({
                        density: zoomBasedReveal(0.5),
                        intensity: 1.0,
                        color: '#a8adbc',
                        opacity: 0.7,
                        vignette: zoomBasedReveal(1.0),
                        'vignette-color': '#464646',
                        direction: [0, 80],
                        'droplet-size': [2.6, 18.2],
                        'distortion-strength': 0.7,
                        'center-thinning': 0
                    });
                }

                // if no temperature is available from local sensor, use the one from the API
                if (!document.getElementById("temperature-val").innerHTML || document.getElementById("temperature-val").innerHTML.trim() == "None") {
                    document.getElementById("temperature-val").innerHTML = data["current"]["temperature_2m"];
                    document.getElementById("temperature-timestamp").innerHTML = "Aktualisiert: " + getTime();
                    document.getElementById("temperature-tile").style.display = "flex";
                }

                // if no wind speed is available from local sensor, use the one from the API
                document.getElementById("wind-speed-val").innerHTML = data["current"]["wind_speed_10m"];
                document.getElementById("wind-speed-timestamp").innerHTML = "Aktualisiert: " + getTime();
                document.getElementById("wind-speed-tile").style.display = "flex";

                // convert wind direction to cardinal direction
                var windDirection = data["current"]["wind_direction_10m"];
                var windArrow = 'south';                
            
                document.getElementById("wind-direction-arrow").style.transform = "rotate(" + windDirection + "deg)";
                document.getElementById("wind-direction-arrow").innerHTML = windArrow;
                document.getElementById("wind-direction-val").innerHTML = windDirection + "°";
                // credits
                document.getElementById("wind-direction-timestamp").innerHTML = 'Aktualisiert: ' + getTime();
                document.getElementById("wind-direction-tile").style.display = "flex";

            })
            .catch((error) => {
                console.error('Error:', error);
            });
        
    }

    function createPlotlyGraph(data_points, time_points, elementId) {
        var trace = {
            x: time_points,
            y: data_points,
            type: 'scatter',
            mode: 'lines+markers',
            marker: { 
                color: '#5856D6',
                size: 8 
            },
            line: { 
                color: '#5856D6',
                width: 2 
            },
        };
        var data = [trace];

        var leftMargin = 20;
        if (elementId == "pressurePlot" || elementId == "temperaturePlot") {
            leftMargin = 30;
        }

        var layout = {
            xaxis: {
                tickangle: 0,
                showgrid: false,
                tickfont: { size: 8, color: '#aaa' },
                fixedrange: true
            },
            yaxis: {
                showgrid: false,
                thickFont: { size: 8, color: '#aaa' },
                fixedrange: true
            },
            margin: { t: 0, l: leftMargin, r: 0, b: 30 },
            paper_bgcolor: '#rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
        };

        Plotly.newPlot(elementId, data, layout, { displayModeBar: false, responsive: true, scrollZoom: false, dragmode: false });
    }



    var hoursTemp = [];
    var temperatures = [];
    var hoursHumidity = [];
    var humidities = [];
    var hoursPM = [];
    var pm_2_5 = [];
    var hoursPressure = [];
    var pressures = [];

    {% for hour in weather_data[0]["all_temp_last_24h"] %}
        hoursTemp.push("{{ hour['two_hour_block'] }}");
        temperatures.push("{{ hour['avg_temperature'] }}");
    {% endfor %}

    {% for hour in weather_data[0]["all_humidity_last_24h"] %}
        hoursHumidity.push("{{ hour['two_hour_block'] }}");
        humidities.push("{{ hour['avg_humidity'] }}");
    {% endfor %}

    {% for hour in weather_data[0]["all_pm_2_5_last_24h"] %}
        hoursPM.push("{{ hour['two_hour_block'] }}");
        pm_2_5.push("{{ hour['avg_pm_2_5'] }}");
    {% endfor %}

    {% for hour in weather_data[0]["all_pressure_last_24h"] %}
        hoursPressure.push("{{ hour['two_hour_block'] }}");
        pressures.push("{{ hour['avg_pressure'] }}");
    {% endfor %}

    createPlotlyGraph(temperatures, hoursTemp, "temperaturePlot");
    createPlotlyGraph(humidities, hoursHumidity, "humidityPlot");
    createPlotlyGraph(pm_2_5, hoursPM, "pm-2-5-Plot");
    createPlotlyGraph(pressures, hoursPressure, "pressurePlot");
    
  </script>

<script>

    {% if not public_version %}

        mapboxgl.accessToken = 'pk.eyJ1IjoieGVsZW1pcjA0IiwiYSI6ImNtNzdpd2RqNDBmemoyanNlY2Vhc2dnaDgifQ.9LELIR3jMIvEEATjOEWz3g';
        const map = new mapboxgl.Map({
            container: 'map',
            center: [{{ locations[0]["lon"] }}, {{ locations[0]["lat"] }}],
            zoom: 16,
            style: 'mapbox://styles/mapbox/standard',
            pitch: 50,
            interactive: false
        
        });

      

      
        map.on('style.load', () => {
            
            map.addSource('mapbox-dem', {
                type: 'raster-dem',
                url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                tileSize: 512,
                maxzoom: 14
            });
            map.setTerrain({ source: 'mapbox-dem', exaggeration: 1 });
            map.addImport({
                id: 'hd-roads',
                url: 'mapbox://styles/mapbox/high-definition-roads',
            });

            map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
                map.setConfigProperty('basemap', 'showRoadLabels', false);
                map.setConfigProperty('basemap', 'showLandmarks', false);
                map.setConfigProperty('basemap', 'showOutdoorLandmarks', false);
                map.setConfigProperty('basemap', 'showTransitLabels', false);
                map.setConfigProperty('basemap', 'showRoadArrows', false);
        });

        var size = 150;

        const pulsingDot = {
            width: size,
            height: size,
            data: new Uint8Array(size * size * 4),


            onAdd: function () {
                const canvas = document.createElement('canvas');
                canvas.width = this.width;
                canvas.height = this.height;
                this.context = canvas.getContext('2d');
            },

            // Call once before every frame where the icon will be used.
            render: function () {
                const duration = 1200;
                const t = (performance.now() % duration) / duration;

                const radius = (size / 2) * 0.3;
                const outerRadius = (size / 2) * 0.8 * t + radius;
                const context = this.context;

                // Draw the outer circle.
                context.clearRect(0, 0, this.width, this.height);
                context.beginPath();
                context.arc(
                    this.width / 2,
                    this.height / 2,
                    outerRadius,
                    0,
                    Math.PI * 2
                );
                context.fillStyle = `rgba(200, 200, 255, ${1 - t})`;
                context.fill();

                // Draw the inner circle.
                context.beginPath();
                context.arc(
                    this.width / 2,
                    this.height / 2,
                    radius,
                    0,
                    Math.PI * 2
                );
                context.fillStyle = '#5856D6';
                context.strokeStyle = '#7876F6';
                context.lineWidth = 2 + 4 * (1 - t);
                context.fill();
                context.stroke();

                // Update this image's data with data from the canvas.
                this.data = context.getImageData(
                    0,
                    0,
                    this.width,
                    this.height
                ).data;

                // Continuously repaint the map, resulting
                // in the smooth animation of the dot.
                map.triggerRepaint();

                // Return `true` to let the map know that the image was updated.
                return true;
            }
        };

        map.on('load', () => {
            {% for location in locations %}
                map.addImage('pulsing-dot-{{ location["location"] }}', pulsingDot, { pixelRatio: 2 });
                map.addSource('point-{{ location["location"] }}', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            {
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [{{ location["lon"] }}, {{ location["lat"] }}]
                                }
                            }
                        ]
                    }
                });
                map.addLayer({
                    id: 'points-{{ location["location"] }}',
                    type: 'symbol',
                    source: 'point-{{ location["location"] }}',
                    layout: {
                        'icon-image': 'pulsing-dot-{{ location["location"] }}',
                        'icon-size': 1
                    }
                });
            {% endfor %}
        });
    {% endif %}


    document.getElementById("temperature-range-selector").addEventListener("change", function() {
        changePlotTimeRange("temperaturePlot", this.value);
    });

    document.getElementById("humidity-range-selector").addEventListener("change", function() {
        changePlotTimeRange("humidityPlot", this.value);
    });

    document.getElementById("pm-2-5-range-selector").addEventListener("change", function() {
        changePlotTimeRange("pm-2-5-Plot", this.value);
    });

    document.getElementById("pressure-range-selector").addEventListener("change", function() {
        changePlotTimeRange("pressurePlot", this.value);
    });

    function changePlotTimeRange(plot_id, selectedOption) {
        var range = selectedOption;
        var index = 0
        var hours = [];
        var data_points = [];

        for (var i = 0; i < weather_data.length; i++) {
            if (weather_data[i]["location"]["location"] == document.getElementById("location-selector").value) {
                index = i;
            }
        }

        if (range == "24h") {
            if (plot_id == "temperaturePlot") {
                for (var i = 0; i < weather_data[index]["all_temp_last_24h"].length; i++) {
                    hours.push(weather_data[index]["all_temp_last_24h"][i]["two_hour_block"]);
                    data_points.push(weather_data[index]["all_temp_last_24h"][i]["avg_temperature"]);
                }
            } else if (plot_id == "humidityPlot") {
                for (var i = 0; i < weather_data[index]["all_humidity_last_24h"].length; i++) {
                    hours.push(weather_data[index]["all_humidity_last_24h"][i]["two_hour_block"]);
                    data_points.push(weather_data[index]["all_humidity_last_24h"][i]["avg_humidity"]);
                }
            } else if (plot_id == "pm-2-5-Plot") {
                for (var i = 0; i < weather_data[index]["all_pm_2_5_last_24h"].length; i++) {
                    hours.push(weather_data[index]["all_pm_2_5_last_24h"][i]["two_hour_block"]);
                    data_points.push(weather_data[index]["all_pm_2_5_last_24h"][i]["avg_pm_2_5"]);
                }
            } else if (plot_id == "pressurePlot") {
                for (var i = 0; i < weather_data[index]["all_pressure_last_24h"].length; i++) {
                    hours.push(weather_data[index]["all_pressure_last_24h"][i]["two_hour_block"]);
                    data_points.push(weather_data[index]["all_pressure_last_24h"][i]["avg_pressure"]);
                }
            }
        } else if (range == "7d") {
            if (plot_id == "temperaturePlot") {
                for (var i = 0; i < weather_data[index]["all_temp_last_7d"].length; i++) {
                    hours.push(weather_data[index]["all_temp_last_7d"][i]["twelve_hour_block"]);
                    data_points.push(weather_data[index]["all_temp_last_7d"][i]["avg_temperature"]);
                }
            } else if (plot_id == "humidityPlot") {
                for (var i = 0; i < weather_data[index]["all_humidity_last_7d"].length; i++) {
                    hours.push(weather_data[index]["all_humidity_last_7d"][i]["twelve_hour_block"]);
                    data_points.push(weather_data[index]["all_humidity_last_7d"][i]["avg_humidity"]);
                }
            } else if (plot_id == "pm-2-5-Plot") {
                for (var i = 0; i < weather_data[index]["all_pm_2_5_last_7d"].length; i++) {
                    hours.push(weather_data[index]["all_pm_2_5_last_7d"][i]["twelve_hour_block"]);
                    data_points.push(weather_data[index]["all_pm_2_5_last_7d"][i]["avg_pm_2_5"]);
                }
            } else if (plot_id == "pressurePlot") {
                for (var i = 0; i < weather_data[index]["all_pressure_last_7d"].length; i++) {
                    hours.push(weather_data[index]["all_pressure_last_7d"][i]["twelve_hour_block"]);
                    data_points.push(weather_data[index]["all_pressure_last_7d"][i]["avg_pressure"]);
                }
            }
        } else if (range == "30d") {
            if (plot_id == "temperaturePlot") {
                for (var i = 0; i < weather_data[index]["all_temp_last_30d"].length; i++) {
                    hours.push(weather_data[index]["all_temp_last_30d"][i]["twentyfour_hour_block"]);
                    data_points.push(weather_data[index]["all_temp_last_30d"][i]["avg_temperature"]);
                }
            } else if (plot_id == "humidityPlot") {
                for (var i = 0; i < weather_data[index]["all_humidity_last_30d"].length; i++) {
                    hours.push(weather_data[index]["all_humidity_last_30d"][i]["twentyfour_hour_block"]);
                    data_points.push(weather_data[index]["all_humidity_last_30d"][i]["avg_humidity"]);
                }
            } else if (plot_id == "pm-2-5-Plot") {
                for (var i = 0; i < weather_data[index]["all_pm_2_5_last_30d"].length; i++) {
                    hours.push(weather_data[index]["all_pm_2_5_last_30d"][i]["twentyfour_hour_block"]);
                    data_points.push(weather_data[index]["all_pm_2_5_last_30d"][i]["avg_pm_2_5"]);
                }
            } else if (plot_id == "pressurePlot") {
                for (var i = 0; i < weather_data[index]["all_pressure_last_30d"].length; i++) {
                    hours.push(weather_data[index]["all_pressure_last_30d"][i]["twentyfour_hour_block"]);
                    data_points.push(weather_data[index]["all_pressure_last_30d"][i]["avg_pressure"]);
                }
            }
        } else if (range == "90d") {
            if (plot_id == "temperaturePlot") {
                for (var i = 0; i < weather_data[index]["all_temp_last_90d"].length; i++) {
                    hours.push(weather_data[index]["all_temp_last_90d"][i]["fifteen_day_block"]);
                    data_points.push(weather_data[index]["all_temp_last_90d"][i]["avg_temperature"]);
                }
            } else if (plot_id == "humidityPlot") {
                for (var i = 0; i < weather_data[index]["all_humidity_last_90d"].length; i++) {
                    hours.push(weather_data[index]["all_humidity_last_90d"][i]["fifteen_day_block"]);
                    data_points.push(weather_data[index]["all_humidity_last_90d"][i]["avg_humidity"]);
                }
            } else if (plot_id == "pm-2-5-Plot") {
                for (var i = 0; i < weather_data[index]["all_pm_2_5_last_90d"].length; i++) {
                    hours.push(weather_data[index]["all_pm_2_5_last_90d"][i]["fifteen_day_block"]);
                    data_points.push(weather_data[index]["all_pm_2_5_last_90d"][i]["avg_pm_2_5"]);
                }
            } else if (plot_id == "pressurePlot") {
                for (var i = 0; i < weather_data[index]["all_pressure_last_90d"].length; i++) {
                    hours.push(weather_data[index]["all_pressure_last_90d"][i]["fifteen_day_block"]);
                    data_points.push(weather_data[index]["all_pressure_last_90d"][i]["avg_pressure"]);
                }
            }
        }

        createPlotlyGraph(data_points, hours, plot_id);
    }


    // on page scroll, scroll out map twice as fast
    window.onscroll = function() {
        var scroll = window.scrollY;
        var map = document.getElementById("map");
        map.style.transform = "translateY(" + scroll / 2 + "px)";

    }

    window.onload = function() {
        updateWeatherAPI({{ locations[0]["lat"] }}, {{ locations[0]["lon"] }});
    }
    

    // theme to dark
    //document.body.setAttribute('data-theme', 'dark');
    // on DOM load
    document.addEventListener("DOMContentLoaded", function() {
        var body = document.body;
    
        // Create the style tag
        var style = document.createElement('style');
        style.innerHTML = `
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #blur-background {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                backdrop-filter: blur(8px);
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }
            #message-box {
                background: var(--bg-tile);
                padding: 2rem 3rem;
                border-radius: 15px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.25);
                text-align: center;
                max-width: 400px;
                font-family: sans-serif;
                position: relative;
            }
            #message-box h1 {
                font-size: 1.5rem;
                margin: 0 0 1rem 0;
                color: var(--text);
            font-family: 'Nunito', sans-serif;
            }
            #close-button {
                margin-top: 1.5rem;
                padding: 0.5rem 1rem;
                font-size: 1rem;
                border: none;
                background-color: var(--accent);
                font-family: 'Nunito', sans-serif;
                color: white;
                border-radius: 8px;
                cursor: pointer;
            }
        `;
        document.head.appendChild(style);
    
        // Create the blur background
        var blurBackground = document.createElement('div');
        blurBackground.id = 'blur-background';
    
        // Create the message box
        var messageBox = document.createElement('div');
        messageBox.id = 'message-box';
    
        // Create the heading
        var heading = document.createElement('h1');
        heading.textContent = 'Diese Seite wurde nicht vom Website-Besitzer bezahlt';
    
        // Create the close button
        var closeButton = document.createElement('button');
        closeButton.id = 'close-button';
        closeButton.textContent = 'Trotzdem weiter';
        closeButton.addEventListener('click', function() {
            blurBackground.remove();
        });
    
        // Assemble everything
        messageBox.appendChild(heading);
        messageBox.appendChild(closeButton);
        blurBackground.appendChild(messageBox);
        body.appendChild(blurBackground);
    });
</script>